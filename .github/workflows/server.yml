name: ğŸš€ Deploy Safeplug Backend to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

# Security: Limit permissions to minimum required
permissions:
  contents: read

jobs:
  deploy:
    name: ğŸ³ Deploy Backend Container
    runs-on: ubuntu-latest
    # Security: Set timeout to prevent hanging workflows
    timeout-minutes: 15
    
    # Security: Define environment for deployment
    environment:
      name: production
      url: https://server.safeplug.com

    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Set up SSH with Host Key Verification
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ”‘ Add VPS Host Key (Security:Prevent MITM attacks)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_HOST_KEY }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: ğŸ§  Test SSH connection
        run: |
          ssh -o BatchMode=yes ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo 'âœ… SSH connection successful!'"

      - name: ğŸ“¦ Upload backend code to VPS
        run: |
          rsync -az --delete \
            -e "ssh -o BatchMode=yes" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='.env.local' \
            ./ \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/root/safeplug/safeplugbackend/

      - name: ğŸ“ Securely create .env file on VPS
        run: |
          # Security: Use heredoc with proper quoting and set secure permissions
          ssh -o BatchMode=yes ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'cat > /root/safeplug/safeplugbackend/.env && chmod 600 /root/safeplug/safeplugbackend/.env' << 'ENVEOF'
          ${{ secrets.ENV_FILE }}
          ENVEOF
          echo "âœ… .env file created with secure permissions"

      - name: ğŸ³ Build and Run Docker Container
        run: |
          ssh -o BatchMode=yes ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e
            cd /root/safeplug/safeplugbackend

            echo "ğŸ›‘ Stopping existing container..."
            docker stop safeplug-backend 2>/dev/null || true
            docker rm safeplug-backend 2>/dev/null || true

            echo "ğŸ—‘ï¸ Removing old safeplug-backend image only..."
            docker rmi safeplug-backend:1.0 --force 2>/dev/null || true

            echo "ğŸ—ï¸ Building new image..."
            docker build --no-cache -t safeplug-backend:1.0 .

            echo "ğŸš€ Starting container with security options..."
            docker run -d \
              --name safeplug-backend \
              --network eseek-network \
              -p 127.0.0.1:5001:5001 \
              --env-file /root/safeplug/safeplugbackend/.env \
              --restart always \
              --read-only \
              --tmpfs /tmp:rw,noexec,nosuid,size=100m \
              --security-opt=no-new-privileges:true \
              --cap-drop=ALL \
              --cap-add=NET_BIND_SERVICE \
              safeplug-backend:1.0

            echo "ğŸ§¹ Cleaning up only dangling images..."
            docker image prune -f

            echo "âœ… Backend deployed successfully!"
          EOF

      - name: âœ… Verify Deployment
        run: |
          ssh -o BatchMode=yes ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            echo "ğŸ“Š Docker Status:"
            docker ps | grep safeplug-backend || echo "âš ï¸ Container not running"
            echo ""
            echo "ğŸ” Health check:"
            curl -sf http://localhost:5001/api/health > /dev/null && echo "âœ… Backend API responding" || echo "âš ï¸ Backend not responding (may need different health endpoint)"
          EOF




