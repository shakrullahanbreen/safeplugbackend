name: ğŸš€ Deploy Safeplug Backend to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸ³ Deploy Backend Container
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ§  Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo 'âœ… SSH connection successful!'"

      - name: ğŸ“¦ Upload backend code to VPS
        run: |
          rsync -az --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            ./ \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/root/safeplug/safeplugbackend/

      - name: ğŸ“ Create .env file on VPS
        run: |
          echo "${{ secrets.ENV_FILE }}" | ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "cat > /root/safeplug/safeplugbackend/.env"

      - name: ğŸ³ Build and Run Docker Container
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e
            cd /root/safeplug/safeplugbackend

            echo "ğŸ›‘ Stopping existing container..."
            docker stop safeplug-backend 2>/dev/null || true
            docker rm safeplug-backend 2>/dev/null || true

            echo "ğŸ—‘ï¸ Removing old image..."
            docker rmi safeplug-backend:1.0 --force 2>/dev/null || true

            echo "ğŸ—ï¸ Building new image..."
            docker build --no-cache -t safeplug-backend:1.0 .

            echo "ğŸš€ Starting container on port 5001..."
            docker run -d \
              --name safeplug-backend \
              --network eseek-network \
              -p 5001:5001 \
              --env-file /root/safeplug/safeplugbackend/.env \
              --restart always \
              safeplug-backend:1.0

            echo "ğŸ§¹ Cleaning up unused images..."
            docker image prune -f

            echo "âœ… Backend deployed successfully!"
          EOF

      - name: âœ… Verify Deployment
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            echo "ğŸ“Š Docker Status:"
            docker ps | grep safeplug-backend || echo "âš ï¸ Container not running"
            echo ""
            echo "ğŸ§¾ Last 20 log lines:"
            docker logs safeplug-backend --tail 20 2>/dev/null || echo "âš ï¸ No logs yet"
          EOF
